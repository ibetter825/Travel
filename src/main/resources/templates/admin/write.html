<!DOCTYPE html>
<html lang="en">

<head>
	<#assign title="文章新增">
	<meta name="referrer" content="never">
	<#include "/admin/includes/header.html"/>
	<link id="tagcss" rel="stylesheet" href="/admin/css/jquery.tag-editor.css" />
	<style>
	.art-header {position: fixed; width: 100%; top: 5px; left: 0; z-index: 19891014; background: #fff;}
	.art-title input {margin: 0 5%; width: 90%; height: 30px; line-height: 30px; letter-spacing: 2px; font-size: 16px; text-align: center; border-width: 0 0 1px 0;}
	#editor {height: 500px; margin-top: 80px;}
	#saveMenu {position: absolute; right: 5px;}
	#saveMenu i {font-size: 18px; color: #D15B47;}
	#saveMenu i:hover {color: #307ECC;}
	#musicMenu i {position: relative; left: -2px; top: -2px;}
	.reco-tags .col-sm-9 {padding-top: 4px;}
	</style>
</head>

<body class="custom">
	<div class="page-content">
		<div class="row">
			<div class="col-xs-12">
				<div class="art-header">
					<div id="toolbar"></div>
					<h4 class="art-title">
						<input type="text" id="art-title" placeholder="请输入标题"/>
						<input type="hidden" id="art-song" value=""/>
					</h4>
				</div>
				<div id="editor"></div>
			</div><!-- /.col -->
		</div>
		<!-- /row -->
		<!-- PAGE CONTENT ENDS -->
		<div id="dialog-model" class="dialog-model-hide">
			<form id="tag-form" class="form-horizontal" role="form" onsubmit="return submitForm();">
				<div class="widget-box no-border">
					<div class="widget-header header-color-blue">
						<h6><i class="icon-leaf"></i>选择标签并保存文章</h6>
					</div>
					<div class="widget-body">
						<div class="widget-main">
							<div class="form-group">
								<label class="col-sm-3 control-label no-padding-right" for="art-tags">标签</label>
								<div class="col-sm-7">
									<input type="text" id="art-tags">
								</div>
							</div>
							<div class="form-group reco-tags">
								<label class="col-sm-3 control-label no-padding-right">常用</label>
								<div class="col-sm-9">
									<button type="button" class="btn btn-minier btn-pink">标签1</button>
									<button type="button" class="btn btn-minier btn-pink">标签2</button>
									<button type="button" class="btn btn-minier btn-pink">标签3</button>
									<button type="button" class="btn btn-minier btn-pink">标签4</button>
									<button type="button" class="btn btn-minier btn-pink">标签5</button>
								</div>
							</div>
							<div class="form-group reco-tags">
								<label class="col-sm-3 control-label no-padding-right">热门</label>
								<div class="col-sm-9">
									<button type="button" class="btn btn-minier btn-primary">标签1</button>
									<button type="button" class="btn btn-minier btn-primary">标签2</button>
									<button type="button" class="btn btn-minier btn-primary">标签3</button>
									<button type="button" class="btn btn-minier btn-primary">标签4</button>
									<button type="button" class="btn btn-minier btn-primary">标签5</button>
								</div>
							</div>
						</div>
						<div class="widget-toolbox padding-8 clearfix">
							<button type="button" class="btn btn-sm btn-danger pull-right" onclick="layer.closeAll('page');">
								<i class="icon-trash"></i><span class="bigger-110"> 取&nbsp;消</span>
							</button>
							<button type="submit" class="btn btn-sm btn-primary pull-right">
								<i class="icon-ok"></i><span class="bigger-110"> 确&nbsp;定</span>
							</button>
						</div>
					</div>
				</div>
			</form>
		</div>
		<div class="dialog-model-hide">
			<audio id="audio" src="" autoplay="autoplay" controls="controls">
			您的浏览器不支持 audio 标签。
			</audio>
		</div>
	</div>
	
	<!-- basic scripts -->
	<#include "/admin/includes/footer.html"/>
	<script src="/admin/js/editor/wangEditor.min.js"></script>
	<script src="/admin/js/jquery.tag-editor.min.js"></script>
	<script type="text/javascript">
	//百度音乐api: 参考https://www.jianshu.com/p/a6718b11fdf1
	//百度音乐搜索api: http://tingapi.ting.baidu.com/v1/restserver/ting?format=json&calback=&from=webapp_music&method=baidu.ting.search.catalogSug&query=海阔天空
	//搜听api: method=baidu.ting.song.play&songid=877578
	jQuery.jsonp = function (url, func) {
    	var callback = "jsonpCallback_" + new Date().getTime() + Math.floor(Math.random() * 1000000);
        url = url + (url.indexOf( '?' ) + 1 ? '&' : '?') + 'callback=' + callback;
	    window[callback] = function (data) {
	        func(data);
	        window[callback] = null;
	    };
	    script = document.createElement('script');
	    script.setAttribute('src', url);
	    document.body.appendChild(script);
	};
	/* var u = 'http://tingapi.ting.baidu.com/v1/restserver/ting?format=json&calback=&from=webapp_music&method=baidu.ting.search.catalogSug&query=海阔天空';
	$.jsonp(u, function(data){
		console.log(data);
	}); */
	var u = 'http://tingapi.ting.baidu.com/v1/restserver/ting?format=json&calback=&from=webapp_music&method=baidu.ting.song.play&songid=877578';
	$.jsonp(u, function(data){
		console.log(data);
		//需要在顶部加上标签： <meta name="referrer" content="never"> 才能播放
		//$('#audio').attr('src', data.bitrate.file_link);
	});
	$(function(){
		resizeEditor();
		initTagEditor();
		initEditor();
		$(window).resize(function(){
			resizeEditor();
		});
	});
	function resizeEditor(){
		$('#editor').height($(window).height() - 100);
	}
	//提交文章
	function submitForm(){
		var title = $('#art-title').val();
		var content = null;//editor.
		var tags = $('#art-tags').val();
		//post to server
		return false;
	}
	//初始化标签
	function initTagEditor(){
		var artTags = $('#art-tags');
	    artTags.tagEditor({
	        placeholder: '添加标签...',
	        onChange: function(field, editor, tags) {
	        	if(tags.length > 5){
	        		layer.msg('不能超过5个标签!', {time:800})
	            	artTags.tagEditor('removeTag', tags[5]);
	            }
	        }
	    });
	    //推荐标签的点击事件
	    $('.reco-tags').on('click', '.btn', function(){
	    	var tag = $(this).text();
	    	artTags.tagEditor('addTag', tag);
	    });
	}
	var E = window.wangEditor;
	//初始化编辑器
	function initEditor(){
		//自定义菜单 - START
		//自定义保存菜单
	    E.save = {
    		// editor create之后调用
    		init: function(){
    			$(".w-e-toolbar").append('<div id="saveMenu" class="w-e-menu" title="保存"><i class="icon-save"></i></div>');
    			$('#saveMenu').click(function(){
    				E.save.submit();
    			});
    		},
    		submit: function(){
    			$tagModel = $('#dialog-model');
    			$tagModel.removeClass('dialog-model-hide')
    			//首先弹出标签选择页面
    			layer.open({
    			  id: 'layer-tag-model',
		  		  type: 1,
		  		  title: false,
		  		  move: '.widget-header',
		  		  closeBtn: 0,
		  		  skin: 'dialog-model',
		  		  shade: false,
		  		  shadeClose: true,
		  		  area: ['560px'],
		  		  content: $tagModel,
		  		  success: function(){
		  			$('#layer-tag-model').removeAttr('style'); 
		  		  },
		  		  end: function(){
		  			$tagModel.addClass('dialog-model-hide');
		  		  }
				});
    		}
    	};
    	//自定义音乐菜单
	    E.music = {
    		// editor create之后调用
    		init: function(){
    			$(".w-e-toolbar").append('<div id="musicMenu" class="w-e-menu" title="插入音乐"><i class="icon-music"></i></div>');
    			$('#musicMenu').click(function(e){
    				E.music.open();
    				e.stopPropagation();
    			});
    		},
    		open: function(){
    			var $artSong = $('#art-song');
    			var song = $artSong.val();
    			if(song.indexOf(':-:') > -1)
    				song = song.split(':-:')[1];
    			else
    				song = '';
    			var arr = [];
    			arr.push('<div class="w-e-panel-container w-e-panel-music" style="width:350px; margin-left:-175px;"><i onclick="E.music.close(this);" class="w-e-icon-close w-e-panel-close"></i><ul class="w-e-panel-tab-title"><li class="w-e-item w-e-active">插入音乐</li></ul><div class="w-e-panel-tab-content"><div>');
                arr.push('<input onKeyUp="E.music.search(this);" type="text" class="block" placeholder="搜索音乐" value="'+song+'">');
				arr.push('<select class="form-control" style="display:none;" multiple="multiple"></select>');
                arr.push('<div class="w-e-button-container">');
                arr.push('<button onClick="E.music.add(this);" class="right">确定</button>');
                arr.push('</div>');
                arr.push('</div></div></div>');
    			$('#editor').append(arr.join(''));
    			$(document).unbind('click').on('click', function(){
    				$('.w-e-panel-music').remove();
    			});
    			$('.w-e-panel-music').on('click', function(e){
    				e.stopPropagation();
    			});
    		},
    		search: function(input){
    			var $input = $(input);
    			var val = $.trim($input.val());
    			var $select = $input.siblings('select');
    			if(/^[s　]|[ ]$/gi.test(val) || val === ''){
    				$select.slideUp();
    				return;
    			}
    			var lasy = $input.attr('lasy');
    			var time = new Date().getTime();
    			if(lasy){
    				//超过1秒钟才查询
    				if(time - Number(lasy) <= 1000) return;
    			}
    			$input.attr('lasy', time);
    			var u = 'http://tingapi.ting.baidu.com/v1/restserver/ting?format=json&calback=&from=webapp_music&method=baidu.ting.search.catalogSug&query=' + val;
				$.jsonp(u, function(data){
					var errno = data.errno;
					if(errno == 22001){//没有查询到数据
						$select.slideUp();
					}else{
						$select.slideDown();
						var list = data.song;
						var songid,songname,artistname,html = [];
						for(var i = 0, l = list.length; i < l; i++){
							songid = list[i]['songid'];
							songname = list[i]['songname'];
							artistname = list[i]['artistname'];
							html.push('<option value="'+songid+':-:'+songname+'">'+songname+' ['+artistname+']</option>');
						}
						$select.empty().append(html.join(''));
					}
				});
    		},
    		add: function(btn){
    			var $artSong = $('#art-song');
    			var $select = $(btn).parent().siblings('select');
    			$artSong.val($select.val());
    			E.music.close($select);
    		},
    		close: function(obj){
    			$(obj).parents('.w-e-panel-container').remove();
    		}
    	};
		//自定义菜单 - END
		
	    var editor = new E('#toolbar', '#editor');
	    editor.customConfig.menus = [
		    'head',  // 标题
		    'bold',  // 粗体
		    'italic',  // 斜体
		    'underline',  // 下划线
		    'strikeThrough',  // 删除线
		    'foreColor',  // 文字颜色
		    'backColor',  // 背景颜色
		    'link',  // 插入链接
		    'list',  // 列表
		    'justify',  // 对齐方式
		    'quote',  // 引用
		    'emoticon',  // 表情
		    'image',  // 插入图片
		    'table',  // 表格
		    'video',  // 插入视频
		    'undo',  // 撤销
		    'redo'  // 重复
	    ];
	    // 配置服务器端地址
		editor.customConfig.uploadImgServer = '/common/upload/editor.json';
		// 将图片大小限制为 20M
		editor.customConfig.uploadImgMaxSize = 20 * 1024 * 1024
		//可自定义filename
		editor.customConfig.uploadFileName = 'file';
		editor.customConfig.customAlert = function (info) {
		    // info 是需要提示的内容
		    layer.msg(info);
		}
	    editor.create();
	    E.save.init();//初始化菜单操作
	    E.music.init();//初始化音乐菜单
	}
	</script>
</body>

</html>